<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<title>Assistant de Rédaction – Status psychiatrique</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root {
  --bg-page: #f1f5f9;
  --bg-card: #f8fafc;
  --accent: #2563eb;
  --accent-light: #e9f2ff;
  --highlight-active: #bfdbfe;  
  --text-main: #0f172a;
  --text-sub: #475569;
  --radius: 8px;
  --bord: 1px solid #e2e8f0;
  --font-main: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
}

/* PAGE GLOBALE */
body {
  font-family: var(--font-main);
  color: var(--text-main);
  background: var(--bg-page);
  margin: 0;
  padding: 16px 24px;
  line-height: 1.45;
}

/* TITRES */
h1 {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--accent);
  margin: 0 0 10px;
}
h2 {
  font-size: 1.05rem;
  margin: 8px 0 2px;
  color: var(--text-main);
  border-left: 3px solid var(--accent);
  padding-left: 6px;
}

/* BLOCS REPLIÉS */
.collapsible {
  cursor: pointer;
  background: var(--accent-light);
  border: 1px solid #bae6fd;
  border-radius: var(--radius);
  padding: 7px 10px;
  font-weight: 700;
  color: var(--accent);
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-top: 4px;
  user-select: none;
}
.collapsible::after {
  content: "▼";
  font-size: 0.9rem;
  transition: transform 0.25s ease;
}
.collapsible.collapsed::after { transform: rotate(-90deg); }
.collapsible + .content {
  overflow: hidden;
  transition: max-height 0.25s ease;
  max-height: 2000px;
}
.collapsible.collapsed + .content { max-height: 0; }

/* COMPACTAGE ENTRE BLOCS */
.content {
  margin: 0; /* élimine tout espace vertical entre sections */
  padding-top: 0px;
  padding-bottom: 0px;
}

/* CARTES */
.card {
  background: var(--bg-card);
  border: var(--bord);
  border-radius: var(--radius);
  padding: 10px 12px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.04);
}
.group-title { font-weight: 700; margin-bottom: 4px; }
.sub {  font-weight: 700;       
  color: var(--text-main); 
  margin: 8px 0 4px; }

/* LAYOUT */
.grid, .grid2 { display: grid; gap: 8px; }
.grid { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
.grid2 { grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); }
.grid3 {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 8px;
}
/* CHAMPS */
select, input[type="text"], textarea {
  font: inherit;
  border: var(--bord);
  border-radius: 6px;
  padding: 6px 8px;
  width: 100%;
  background: #fff;
  box-sizing: border-box;
}
select:focus, input:focus, textarea:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 1px var(--accent-light);
}
textarea { resize: vertical; }

label {
  display: flex;
  align-items: flex-start;
  gap: 6px;
  cursor: pointer;
  font-size: 0.9rem;
  line-height: 1.3;
}
.opts, .opts-3 { display: grid; gap: 4px 10px; }
.opts { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
.opts-3 { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }

/* BOUTONS */
button {
  font-weight: 600;
  border: none;
  border-radius: 6px;
  padding: 8px 12px;
  cursor: pointer;
  transition: background 0.2s ease;
}
button.primary { background: var(--accent); color: #fff; }
button.secondary { background: #fff; border: 1px solid var(--accent); color: var(--accent); }
.actions { display: flex; gap: 8px; margin: 10px 0; flex-wrap: wrap; }

/* PROMPT GÉNÉRÉ */
#output {
  background: #f8fafc;
  border-left: 3px solid var(--accent);
  border-radius: var(--radius);
  padding: 10px 12px;
  min-height: 120px;
  white-space: pre-wrap;
  font-family: ui-monospace, SFMono-Regular, monospace;
  font-size: 0.9rem;
}

/* AIDE */
.hint { font-size: 0.9rem; color: var(--text-sub); margin: 4px 0 10px; }

/* BOUTON "REMONTER EN HAUT" */
#scrollTop {
  position: fixed;
  bottom: 16px;
  right: 16px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 50%;
  width: 38px;
  height: 38px;
  font-size: 1.2rem;
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0,0,0,0.25);
  display: none;
  z-index: 1000;
}
#scrollTop:hover { background: #0284c7; }

/* RESPONSIVE */
@media (max-width: 800px) {
  body { padding: 12px; }
  .grid2 { grid-template-columns: 1fr; }
  button { font-size: 0.9rem; padding: 6px 10px; }
}


.collapsible {
  position: relative; /* Nécessaire pour positionner l'icône de reset */
}

.reset-section {
  position: absolute;
  right: 35px; /* Positionne l'icône juste avant la flèche de pliage */
  top: 50%;
  transform: translateY(-50%);
  font-size: 1.2rem;
  font-weight: normal;
  color: var(--text-sub);
  cursor: pointer;
  padding: 0 5px;
  line-height: 1;
  border-radius: 4px;
  user-select: none; /* Empêche la sélection du texte de l'icône */
}

.reset-section:hover {
  background-color: rgba(0,0,0,0.1);
  color: var(--text-main);
}

/* ---- STYLE POUR LE FOOTER ---- */
footer {
  text-align: center;
  margin-top: 40px;
  padding-top: 20px;
  border-top: 1px solid #e2e8f0; /* Ligne de séparation fine */
  font-size: 0.85rem;
  color: var(--text-sub);
}

footer p {
  margin: 4px 0;
}

footer a {
  color: var(--accent);
  text-decoration: none;
}

footer a:hover {
  text-decoration: underline;
}


/* ---- BLOC CSS UNIFIÉ POUR TOUTES LES CASES À COCHER ---- */

/* 1. On cache la case native partout */
input[type="checkbox"] {
    appearance: none;
    -webkit-appearance: none;
    position: absolute;
    opacity: 0;
}

/* 2. On crée notre case personnalisée de base (un carré) */
div[class*="opts"] label::before {
    content: '';
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 1px solid #94a3b8;
    border-radius: 4px;
    background-color: #fff;
    transition: all 0.2s ease;
    margin-right: 6px;
    flex-shrink: 0;
}

/* 3. Style au survol pour TOUTES les cases */
div[class*="opts"] label:hover::before {
    border-color: var(--accent);
}

/* 4. Style d'une case (carré) COCHÉE */
/* PRÉFIXÉ PAR div[...] POUR AUGMENTER LA SPÉCIFICITÉ */
div[class*="opts"] label.is-checked::before {
    background-color: var(--accent);
    border-color: var(--accent);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23fff' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M4 8l3 3 5-5'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: center;
}

/* 5. On spécialise les boutons RADIO pour qu'ils soient ronds */
/* ON UTILISE div.opts-radio POUR ÊTRE PLUS SPÉCIFIQUE QUE LA RÈGLE DE BASE */
div.opts-radio label::before {
    border-radius: 50%;
}

/* 6. Style d'un bouton radio COCHÉ (on remplace la coche par un point) */
/* IDEM : ON PRÉCISE LE SÉLECTEUR POUR GAGNER EN PRIORITÉ */
div.opts-radio label.is-checked::before {
    background-image: none;
    box-shadow: inset 0 0 0 4px var(--bg-card);
}

/* ---- STYLE POUR L'AVERTISSEMENT DE CONFIDENTIALITÉ ---- */
.warning-box {
  background-color: #fef2f2; /* Fond rouge très clair */
  border: 1px solid #fca5a5; /* Bordure rouge clair */
  border-left: 4px solid #ef4444; /* Bordure gauche rouge vif pour l'emphase */
  border-radius: var(--radius);
  padding: 12px 16px;
  margin: 16px 0;
  color: #991b1b; /* Texte rouge foncé */
}

.warning-box .warning-title {
  font-weight: 700;
  color: #b91c1c; /* Titre rouge plus foncé */
  margin-bottom: 8px;
  font-size: 1rem;
}

.warning-box p {
  margin: 4px 0 0;
  font-size: 0.9rem;
  line-height: 1.4;
}

.warning-box strong {
    color: #b91c1c;
}

/* ---- NOUVEAU STYLE POUR L'OPTION MAÎTRESSE ET LE SÉPARATEUR ---- */
.master-option {
  font-weight: 600; /* Met le texte en semi-gras pour le distinguer */
}

.separator {
  border: none;
  border-top: 1px solid #e2e8f0; /* Un trait fin et discret */
  margin: 8px 0;
  width: 100%;
  grid-column: 1 / -1; /* Assure que le trait prend toute la largeur du grid */
}

</style>
</head>


<body>

<h1>Assistant de Rédaction Clinique</h1>
<h2>Paramètres de rédaction</h2>
<div class="card">
    <div class="grid2">
        <div>
            <label for="reportStyle"><strong>Style de rédaction :</strong></label>
            <select id="reportStyle">
                <option value="narratif" selected>Bloc narratif unique</option>
                <option value="detaille">Statut détaillé par rubriques</option>
            </select>
        </div>
        <div>
            <label for="patientGender"><strong>Sexe/Genre :</strong></label>
            <select id="patientGender">
                <option value="non-precise" selected>Non précisé</option>
                <option value="homme">Homme</option>
                <option value="femme">Femme</option>
                <option value="autre">Autre</option>
            </select>
        </div>
    </div>
</div>
<div class="warning-box">
    <div class="warning-title">⚠️ Avertissement Important : Confidentialité des Données</div>
    <p>N'incluez <strong>JAMAIS</strong> d'informations permettant d'identifier un patient dans ce formulaire. Cet outil n'est pas sécurisé pour les données de santé sensibles.</p>
    <p><strong>Exemples d'informations interdites :</strong> nom, initiales, date de naissance, numéro de dossier, adresse, etc.</p>
    <p>Utilisez uniquement des descriptions cliniques anonymes et fictives.</p>
</div>

<div class="actions">
  <button id="toggleAll" class="secondary">Tout replier</button>
</div>

<!-- ====================== SECTION A : PRÉSENTATION / LANGAGE ====================== -->
<div class="collapsible">A — Présentation / Langage</div>
<div class="content">
  <div class="grid">
    <div class="card">
      <div class="group-title">Tenue vestimentaire</div>
      <div class="opts-3 opts-radio">
        <label><input type="checkbox" id="tenue_norm"> Sans particularité</label>
        <label><input type="checkbox" id="tenue_bizarre"> Extravagante ou bizarre</label>
      </div>

      <div class="sub">Hygiène corporelle</div>
      <div class="opts-3 opts-radio">
        <label><input type="checkbox" id="hyg_ok"> Bonne</label>
        <label><input type="checkbox" id="hyg_incurie"> Négligée / incurie</label>
      </div>

      <div class="sub">Contact</div>
        <div class="opts-3 opts-radio">
          <label><input type="checkbox" id="ctc_ok"> Sans particularité</label>
          <label><input type="checkbox" id="ctc_reticent"> Réticence</label>
          <label><input type="checkbox" id="ctc_familiarite"> Familiarité</label>
          <label><input type="checkbox" id="ctc_bizarre"> Bizarrerie</label>
        </div>
    </div>

    <div class="card">
      <div class="sub">Comportement interpersonnel</div>
        <div class="opts-3 opts-radio">
          <label><input type="checkbox" id="comp_ok"> Sans particularité (patient coopérant)</label>
          <label><input type="checkbox" id="comp_dim"> Diminué (non-coopérant, clinophilie, retrait social)</label>
          <label><input type="checkbox" id="comp_desinhibe"> Désinhibé (ludisme, familiarité, agressivité, hostilité)</label>
          <label><input type="checkbox" id="comp_inadapte"> Inadapté (bizarrerie comportementale, actes insolites)</label>
        </div>
      <div class="sub">Autre précision</div>
      <input type="text" id="ctc_autre" placeholder="ex. évitement du regard, réponses laconiques">
    </div>

    <div class="card">
      <div class="group-title">Langage</div>

      <div class="sub">Prosodie</div>
      <div class="opts-3 opts-radio">
        <label><input type="checkbox" id="pros_norm"> Normale</label>
        <label><input type="checkbox" id="pros_alt"> Altérée</label>
      </div>

      <div class="sub">Intensité sonore</div>
      <div class="opts-3 opts-radio">
        <label><input type="checkbox" id="int_norm"> Normale</label>
        <label><input type="checkbox" id="int_hypo"> Diminuée (hypophonie)</label>
        <label><input type="checkbox" id="int_hyper"> Augmentée (hyperphonie)</label>
      </div>

      <div class="sub">Rythme & quantité</div>
      <div class="opts-3 opts-radio">
        <label><input type="checkbox" id="ryth_norm"> Normaux</label>
        <label><input type="checkbox" id="ryth_dimin"> Diminués (bradyphémie/latences/alogie)</label>
        <label><input type="checkbox" id="ryth_augm"> Augmentés (logorrhée/volubilité)</label>
        <label><input type="checkbox" id="ryth_alt"> Altérés (fading/barrages)</label>
      </div>

      <div class="sub">Signification du langage</div>
      <div class="opts-3 opts-radio">
        <label><input type="checkbox" id="signif_norm"> Normale</label>
        <label><input type="checkbox" id="signif_alt"> Altérée (néologismes, paralogismes…)</label>
      </div>

      <div class="sub">Remarques libres (A)</div>
      <textarea id="lang_rem" rows="3" placeholder="ex. débit légèrement ralenti, articulation conservée…"></textarea>
    </div>
  </div>
</div>

<!-- ====================== SECTION B : PENSÉE – FORME ====================== -->
<div class="collapsible">B — Pensée (forme)</div>
<div class="content">
  <div class="grid">
    <div class="card">
      <div class="group-title">Rythme de pensée</div>
      <div class="opts-3 opts-radio">
        <label><input type="checkbox" id="p_ryth_norm"> Normal</label>
        <label><input type="checkbox" id="p_ryth_ral"> Ralenti (bradypsychie)</label>
        <label><input type="checkbox" id="p_ryth_acc"> Accéléré (tachypsychie / fuite des idées)</label>
      </div>

      <div class="sub">Cours de pensée</div>
      <div class="opts-3 opts-radio">
        <label><input type="checkbox" id="p_cours_log"> Logique / cohérent</label>
        <label><input type="checkbox" id="p_cours_diff"> Diffluent</label>
        <label><input type="checkbox" id="p_cours_illog"> Illogique</label>
      </div>

      <div class="sub">Blocage / barrages (cumulable)</div>
      <div class="opts">
        <label><input type="checkbox" id="p_blocage"> Présent</label>
      </div>
    </div>

    <div class="card">
      <div class="group-title">Remarques libres (B)</div>
      <textarea id="p_forme_rem" rows="6" placeholder="ex. diffluence majorée en début d'entretien, barrages fréquents…"></textarea>
    </div>
  </div>
</div>

<!-- ====================== SECTION C : PENSÉE – CONTENU ====================== -->
<div class="collapsible">C — Pensée (contenu)</div>
<div class="content">
  <div class="grid">
  <!-- Carte 1 : items pathologiques fréquents -->
    <div class="card">
      <div class="group-title">Idées pathologiques</div>

      <div class="sub">Général</div>
      <div class="opts">
        <label><input type="checkbox" id="c_delire"> Idées délirantes (voir détails à droite)</label>
        <label><input type="checkbox" id="c_inquietudes"> Soucis et inquiétudes excessifs</label>
        <label><input type="checkbox" id="c_obsessions"> Idées obsessionnelles</label>
        <label><input type="checkbox" id="c_flashbacks"> Reviviscences / remémorations / flashbacks</label>
        <label><input type="checkbox" id="c_phobies"> Idées phobiques</label>
        <label><input type="checkbox" id="c_anticipation"> Idées liées à une anxiété anticipatoire</label>
        <label><input type="checkbox" id="c_depressif"> Idées liées à l’humeur dépressive (négatives, dévalorisation, incurabilité)</label>
        <label><input type="checkbox" id="c_exalte"> Idées liées à l’humeur exaltée (positives, de grandeur, optimisme démesuré)</label>
        <label><input type="checkbox" id="c_suicide"> Idées de mort / idées de suicide</label>
      </div>

      <div class="sub">Précisions suicidaires (si cochées)</div>
      <input type="text" id="c_suicide_prec" placeholder="ex. passives / actives / planification / antécédents">

      <div class="sub">Remarques libres (C1)</div>
      <textarea id="c_rem" rows="4" placeholder="ex. inquiétudes centrées sur la santé, rituels obsessionnels discrets…"></textarea>
    </div>

    <!-- Carte 2 : détails du délire -->
    <!-- Carte 2 : détails du délire -->
    <div class="card">
      <div class="group-title">Détails du délire (si présent)</div>

      <div class="sub">Thématiques</div>
      <div class="opts">
        <label><input type="checkbox" id="d_pers"> Persécution</label>
        <label><input type="checkbox" id="d_interp"> Interprétation</label>
        <label><input type="checkbox" id="d_ref"> Référence</label>
        <label><input type="checkbox" id="d_infl"> Influence</label>
        <label><input type="checkbox" id="d_megalo"> Mégalomanie</label>
        <label><input type="checkbox" id="d_hypo"> Hypochondrie / somatique</label>
        <label><input type="checkbox" id="d_culp"> Culpabilité</label>
        <label><input type="checkbox" id="d_jal"> Jalousie</label>
        <label><input type="checkbox" id="d_ero"> Érotomanie</label>
        <label><input type="checkbox" id="d_myst"> Mystique</label>
        <label><input type="checkbox" id="d_ruine"> Ruine</label>
        <label><input type="checkbox" id="d_fil"> Filiation</label>
        <label><input type="checkbox" id="d_rev"> Revendication</label>
        <label><input type="checkbox" id="d_neg"> Négation (syndrome de Cotard)</label>
        <label><input type="checkbox" id="d_trans"> Transformation corporelle</label>
        <label><input type="checkbox" id="d_ident"> Identitaire</label>
        <label><input type="checkbox" id="d_complot"> Complotiste</label>
        <label><input type="checkbox" id="d_cosm"> Cosmique</label>
        <label><input type="checkbox" id="d_meta"> Métaphysique</label>
      </div>

      <div class="sub">Mécanismes</div>
      <div class="opts">
        <label><input type="checkbox" id="m_interp"> Interprétatif</label>
        <label><input type="checkbox" id="m_hall"> Hallucinatoire</label>
        <label><input type="checkbox" id="m_intuit"> Intuitif</label>
        <label><input type="checkbox" id="m_pass"> Passionnel</label>
        <label><input type="checkbox" id="m_imag"> Imaginatif</label>
        <label><input type="checkbox" id="m_onir"> Onirique</label>
        <label><input type="checkbox" id="m_mnem"> Mnémonique (fabulation)</label>
        <label><input type="checkbox" id="m_sugg"> Suggéré / induit</label>
      </div>

      <div class="sub">Organisation du délire</div>
      <div class="opts-3 opts-radio">
        <label><input type="checkbox" id="d_sys"> Systématisé</label>
        <label><input type="checkbox" id="d_parano"> Paranoïde</label>
      </div>

      <div class="sub">Temporalité du délire</div>
      <div class="opts-3 opts-radio">
        <label><input type="checkbox" id="d_aigu"> Aiguë (&lt; 1 mois)</label>
        <label><input type="checkbox" id="d_chron"> Chronique (&gt; 1 mois)</label>
      </div>

      <div class="sub">Retentissement émotionnel et comportemental</div>
      <textarea id="d_rem" rows="4" placeholder="ex. anxiété, irritabilité, méfiance, retrait social, comportements d’évitement…"></textarea>
    </div>
  </div>
</div>

<!-- ====================== SECTION D : AFFECTIVITÉ ====================== -->
<div class="collapsible">D — Affectivité</div>
<div class="content">
  <div class="grid2">
    <div class="card">
      <div class="group-title">Émotions</div>
      <div class="opts-3 opts-radio">
        <label><input type="checkbox" id="aff_emo_norm"> Normales</label>
        <label><input type="checkbox" id="aff_emo_dim"> Diminuées (apathie, émoussement)</label>
        <label><input type="checkbox" id="aff_emo_aug"> Augmentées (hyperréactivité)</label>
        <label><input type="checkbox" id="aff_emo_labile"> Labiles</label>
        <label><input type="checkbox" id="aff_emo_inadap"> Inadaptées</label>
      </div>

      <div class="sub">Humeur</div>
      <div class="opts-3 opts-radio">
        <label><input type="checkbox" id="aff_euth"> Euthymie</label>
        <label><input type="checkbox" id="aff_depr"> Dépressive</label>
        <label><input type="checkbox" id="aff_exal"> Exaltée</label>
        <label><input type="checkbox" id="aff_mixte"> Mixte</label>
      </div>

      <div class="sub">Autres éléments</div>
      <div class="opts">
        <label><input type="checkbox" id="aff_anx"> Anxiété </label>
        <label><input type="checkbox" id="aff_irrita"> Irritabilité marquée</label>
        <label><input type="checkbox" id="aff_anhed"> Anhédonie</label>
      </div>
    </div>

    <div class="card">
      <div class="group-title">Remarques libres (D)</div>
      <textarea id="aff_rem" rows="5" placeholder="ex. labilité affective en entretien, anxiété anticipatoire…"></textarea>
    </div>
  </div>
</div>

<!-- ====================== SECTION E : PERCEPTION ====================== -->
<div class="collapsible">E — Perception</div>
<div class="content">
  <div class="grid2">
    <div class="card">
      <div class="group-title">Hallucinations</div>
      <div class="opts">
        <label><input type="checkbox" id="per_ha"> Auditives</label>
        <label><input type="checkbox" id="per_hv"> Visuelles</label>
        <label><input type="checkbox" id="per_hs"> Somesthésiques</label>
        <label><input type="checkbox" id="per_holf"> Olfactives</label>
        <label><input type="checkbox" id="per_hgust"> Gustatives</label>
      </div>

      <div class="sub">Autres phénomènes</div>
      <div class="opts">
        <label><input type="checkbox" id="per_illu"> Illusions</label>
        <label><input type="checkbox" id="per_intra"> Phénomènes intrapsychiques</label>
      </div>
    </div>

    <div class="card">
      <div class="group-title">Précisions perceptives</div>
      <input type="text" id="per_prec" placeholder="ex. voix commentatives/impératives, visions fugaces…">
      <div class="sub">Remarques libres (E)</div>
      <textarea id="per_rem" rows="4" placeholder="ex. hallucinations auditives commentatives quotidiennes…"></textarea>
    </div>
  </div>
</div>

<!-- ====================== SECTION F : MOTIVATION ====================== -->
<div class="collapsible">F — Motivation</div>
<div class="content">
  <div class="grid2">
    <div class="card">
      <div class="group-title">Initiative</div>
      <div class="opts-3 opts-radio">
        <label><input type="checkbox" id="mot_norm"> Normale</label>
        <label><input type="checkbox" id="mot_dim"> Diminuée (aboulie)</label>
        <label><input type="checkbox" id="mot_aug"> Augmentée</label>
      </div>
    </div>

    <div class="card">
      <div class="group-title">Remarques libres (F)</div>
      <textarea id="mot_rem" rows="4" placeholder="ex. aboulie marquée pour les actes essentiels…"></textarea>
    </div>
  </div>
</div>

<!-- ====================== SECTION G : ORIENTATION / ATTENTION / MÉMOIRE / FONCTIONS INSTINCTUELLES ====================== -->
<div class="collapsible">G — Cognition / Fonctions instinctuelles</div>
<div class="content">
  <div class="grid3">
    <!-- Colonne 1 : Orientation / Attention / Mémoire -->
    <div class="card">
      <div class="group-title">Orientation</div>
      <div class="opts-3 opts-radio">
        <label><input type="checkbox" id="cog_orient_ok"> Préservée</label>
        <label><input type="checkbox" id="cog_orient_tps"> Désorientation temporelle</label>
        <label><input type="checkbox" id="cog_orient_esp"> Désorientation spatiale</label>
        <label><input type="checkbox" id="cog_orient_tmpesp"> Désorientation temporo-spatiale</label>
      </div>

      <div class="sub">Attention</div>
      <div class="opts-3 opts-radio">
        <label><input type="checkbox" id="cog_att_ok"> Préservée</label>
        <label><input type="checkbox" id="cog_att_def"> Hypoprosexie / distractibilité</label>
      </div>

      <div class="sub">Mémoire</div>
      <div class="opts-3 opts-radio">
        <label><input type="checkbox" id="mem_ok"> Mémoire sans particularité</label>
        <label><input type="checkbox" id="mem_trouble"> Troubles mnésiques (préciser)</label>
      </div>
    </div>

    <!-- Colonne 2 : Fonctions instinctuelles -->
    <div class="card">
      <div class="group-title">Sommeil</div>
      <div class="opts-3 opts-radio">
        <label><input type="checkbox" id="sl_norm"> Normal</label>
        <label><input type="checkbox" id="sl_insom"> Insomnie</label>
        <label><input type="checkbox" id="sl_hypers"> Hypersomnie</label>
      </div>

      <div class="sub">Appétit</div>
      <div class="opts-3 opts-radio">
        <label><input type="checkbox" id="app_norm"> Normal</label>
        <label><input type="checkbox" id="app_dim"> Diminution</label>
        <label><input type="checkbox" id="app_aug"> Augmentation</label>
      </div>

      <div class="sub">Sexualité</div>
      <div class="opts-3 opts-radio">
        <label><input type="checkbox" id="sex_norm"> Normale</label>
        <label><input type="checkbox" id="sex_dim"> Diminution</label>
        <label><input type="checkbox" id="sex_aug"> Augmentation</label>
      </div>
    </div>

    <!-- Colonne 3 : Remarques libres -->
    <div class="card">
      <div class="group-title">Remarques libres (G)</div>
      <textarea id="cog_rem" rows="6" placeholder="ex. distractibilité importante, mémoire conservée, sommeil morcelé…"></textarea>
    </div>
  </div>
</div>

<!-- ====================== SECTION H : MOTRICITÉ ====================== -->
<div class="collapsible">H - Motricité</div>
<div class="content">
  <div class="grid2">
    <!-- Carte gauche -->
    <div class="card">
      <div class="group-title">Mimique faciale</div>
      <div class="opts-3 opts-radio">
        <label><input type="checkbox" id="mot_mim_norm"> Normale</label>
        <label><input type="checkbox" id="mot_mim_dim"> Diminuée (hypomimie, amimie, fixité du regard)</label>
        <label><input type="checkbox" id="mot_mim_aug"> Augmentée (hypermimie)</label>
        <label><input type="checkbox" id="mot_mim_alt"> Altérée qualitativement (grimaces, écho/paramimies, sourires immotivés)</label>
      </div>

      <div class="sub">Activité psychomotrice globale</div>
      <div class="opts-3 opts-radio">
        <label><input type="checkbox" id="mot_act_norm"> Normale</label>
        <label><input type="checkbox" id="mot_act_dim"> Diminuée (ralentissement, bradykinésie, stupeur, prise de posture)</label>
        <label><input type="checkbox" id="mot_act_aug"> Augmentée (accélération, hyperkinésie, akathisie, tasikinésie, hypertonie, agitation)</label>
        <label><input type="checkbox" id="mot_act_alt"> Altérée qualitativement (bizarreries, parakinésies, échopraxie, flexibilité cireuse, catalepsie, négativisme, maniérisme, stéréotypies)</label>
      </div>
    </div>

    <!-- Carte droite -->
    <div class="card">
      <div class="group-title">Remarques libres (H)</div>
      <textarea id="motric_rem" rows="6" placeholder="ex. ralentissement global, fixité du regard, posture rigide..."></textarea>
    </div>
  </div>
</div>

<!-- ====================== SECTION I : JUGEMENT / INSIGHT ====================== -->
<div class="collapsible">I — Jugement / Insight</div>
<div class="content">
  <div class="grid2">
    <div class="card">
      <div class="group-title">Insight</div>
      <div class="opts-3 opts-radio">
        <label><input type="checkbox" id="ins_abs"> Absent</label>
        <label><input type="checkbox" id="ins_part"> Partiel</label>
        <label><input type="checkbox" id="ins_comp"> Complet</label>
      </div>

      <div class="sub">Jugement clinique</div>
      <div class="opts-3 opts-radio">
        <label><input type="checkbox" id="jug_ok"> Adapté</label>
        <label><input type="checkbox" id="jug_alt"> Altéré</label>
        <label><input type="checkbox" id="jug_imp"> Impulsivité / prises de risques</label>
      </div>
    </div>

    <div class="card">
      <div class="group-title">Remarques libres (I)</div>
      <textarea id="ins_rem" rows="4" placeholder="ex. conscience partielle des troubles, minimisation des risques…"></textarea>
    </div>
  </div>
</div>

<!-- ====================== SECTION J : RISQUES ====================== -->
<div class="collapsible">J — Risques</div>
<div class="content">
  <div class="grid2">
    <div class="card">
      <div class="group-title">Évaluation du risque suicidaire</div>
      <div class="opts">
        <label class="master-option"><input type="checkbox" id="r_s_none"> Aucune idéation suicidaire</label>
        
        <hr class="separator">

        <label><input type="checkbox" id="r_s_1"> Souhait de mort</label>
        <label><input type="checkbox" id="r_s_2"> Voulu se faire du mal</label>
        <label><input type="checkbox" id="r_s_3"> Pensées suicidaires</label>
        <label><input type="checkbox" id="r_s_4"> Planification</label>
        <label><input type="checkbox" id="r_s_5"> Tentative de suicide (dernier mois)</label>
        <label><input type="checkbox" id="r_s_6"> Antécédent de tentative de suicide</label>
      </div>
      <div class="sub">Remarques libres (risque suicidaire)</div>
      <textarea id="r_s_rem" rows="4" placeholder="ex. idéation passive sans planification, antécédent unique en 2018…"></textarea>
    </div>

    <div class="card">
      <div class="group-title">Évaluation du risque hétéro-agressif</div>
      <div class="opts">
        <label class="master-option"><input type="checkbox" id="r_h_none"> Aucun risque hétéro-agressif identifié</label>
        
        <hr class="separator">

        <label><input type="checkbox" id="r_h_1"> Antécédents de passage à l’acte</label>
        <label><input type="checkbox" id="r_h_2"> Idées actuelles de passage à l’acte</label>
        <label><input type="checkbox" id="r_h_3"> Accès à des moyens</label>
        <label><input type="checkbox" id="r_h_4"> Possession/projet d’arme à feu</label>
      </div>
      <div class="sub">Remarques libres (risque hétéro-agressif)</div>
      <textarea id="r_h_rem" rows="4" placeholder="ex. antécédent judiciaire ancien, absence d’accès actuel à des armes…"></textarea>
    </div>
  </div>
</div>

<!-- Actions + Sortie -->
<div class="actions">
  <button id="generate">Rédiger la synthèse</button>
  <button class="secondary" id="copy">Copier la synthèse</button>
  <button class="secondary" id="reset">Réinitialiser</button>
</div>

<h2>Synthèse clinique</h2>
<div id="output"></div>

<script>
/* ----------- helpers ----------- */
function $(id){ return document.getElementById(id); }
function val(id){ const el=$(id); return el && el.checked; }
function txtv(id){ const el=$(id); return el ? (el.value || "").trim() : ""; }

/* ----------- EXCLUSIVITE SIMPLE ------------- */
function makeExclusive(ids){
  ids.forEach(id => {
    const el=$(id); if(!el) return;
    el.addEventListener('change', e => {
      if (e.target.checked) {
        ids.forEach(other => { if (other !== id && $(other)) $(other).checked = false; });
      }
    });
  });
}

/* ----------- EXCLUSIVITÉ ASYMÉTRIQUE ----------- */
function makeMasterExclusive(masterId, slaveIds) {
  const masterEl = $(masterId);
  if (!masterEl) return;

  // Si l'option "maître" (Aucun risque) est cochée, on décoche toutes les autres.
  masterEl.addEventListener('change', () => {
    if (masterEl.checked) {
      slaveIds.forEach(id => {
        const el = $(id);
        if (el) el.checked = false;
      });
      // On force la mise à jour visuelle des cases qui ont été modifiées par le code.
      updateCheckboxVisuals(); 
    }
  });

  // Si n'importe quelle autre option est cochée, on décoche l'option "maître".
  slaveIds.forEach(slaveId => {
    const slaveEl = $(slaveId);
    if (slaveEl) {
      slaveEl.addEventListener('change', () => {
        if (slaveEl.checked) {
          masterEl.checked = false;
          // On force la mise à jour visuelle de la case "maître".
          updateCheckboxVisuals();
        }
      });
    }
  });
}

/* exclusivités A */
makeExclusive(["tenue_norm","tenue_bizarre"]);
makeExclusive(["hyg_ok","hyg_incurie"]);
makeExclusive(["pros_norm","pros_alt"]);
makeExclusive(["int_norm","int_hypo","int_hyper"]);
makeExclusive(["ryth_norm","ryth_dimin","ryth_augm","ryth_alt"]);
makeExclusive(["signif_norm","signif_alt"]);
/* exclusivités Contact */
makeExclusive(["ctc_ok","ctc_reticent","ctc_familiarite","ctc_bizarre"]);
/* exclusivité comportement interpersonnel */
makeExclusive(["comp_ok","comp_dim","comp_desinhibe","comp_inadapte"]);
/* exclusivités B */
makeExclusive(["p_ryth_norm","p_ryth_ral","p_ryth_acc"]);
makeExclusive(["p_cours_log","p_cours_diff","p_cours_illog"]);
/* exclusivités D (humeur) */
makeExclusive(["aff_emo_norm","aff_emo_dim","aff_emo_aug","aff_emo_labile","aff_emo_inadap"]);
makeExclusive(["aff_euth","aff_depr","aff_exal","aff_mixte"]);
/* exclusivités délire */
makeExclusive(["d_sys","d_parano"]);
makeExclusive(["d_aigu","d_chron"]);
/* exclusivités F (motivation) */
makeExclusive(["mot_norm","mot_dim","mot_aug"]);
/* exclusivités orientation/attention/mémoire/fonctions instinctuelles */
makeExclusive(["cog_orient_ok","cog_orient_tps","cog_orient_esp","cog_orient_tmpesp"]);
makeExclusive(["cog_att_ok","cog_att_def"]);
makeExclusive(["mem_ok","mem_trouble"]);
makeExclusive(["sl_norm","sl_insom","sl_hypers"]);
makeExclusive(["app_norm","app_dim","app_aug"]);
makeExclusive(["sex_norm","sex_dim","sex_aug"]);
/* exclusivités motricité */
makeExclusive(["mot_mim_norm","mot_mim_dim","mot_mim_aug","mot_mim_alt"]);
makeExclusive(["mot_act_norm","mot_act_dim","mot_act_aug","mot_act_alt"]);
/* exclusivités I */
makeExclusive(["ins_abs","ins_part","ins_comp"]);
makeExclusive(["jug_ok","jug_alt","jug_imp"]);
/* exclusivités J (logique asymétrique) */
makeMasterExclusive('r_s_none', ['r_s_1', 'r_s_2', 'r_s_3', 'r_s_4', 'r_s_5', 'r_s_6']);
makeMasterExclusive('r_h_none', ['r_h_1', 'r_h_2', 'r_h_3', 'r_h_4']);

/* ----------- builders par section ----------- */
function buildA(){
  const lines = [];
  if (val("tenue_norm")) lines.push("- Tenue vestimentaire : sans particularité");
  if (val("tenue_bizarre")) lines.push("- Tenue vestimentaire : extravagante/bizarre");
  if (val("hyg_ok")) lines.push("- Hygiène corporelle : bonne");
  if (val("hyg_incurie")) lines.push("- Hygiène corporelle : négligée/incurie");

  // ---- Contact ----
  const ctc = [];
  if (val("ctc_ok")) ctc.push("contact sans particularité");
  if (val("ctc_reticent")) ctc.push("réticence au contact");
  if (val("ctc_familiarite")) ctc.push("familiarité");
  if (val("ctc_bizarre")) ctc.push("bizarrerie du contact");
  if (ctc.length) lines.push("- Contact : " + ctc.join(", "));

  // ---- Comportement interpersonnel ----
  const comp = [];
  if (val("comp_ok")) comp.push("sans particularité (coopérant)");
  if (val("comp_dim")) comp.push("diminué");
  if (val("comp_desinhibe")) comp.push("désinhibé");
  if (val("comp_inadapte")) comp.push("inadapté");
  if (comp.length) lines.push("- Comportement interpersonnel : " + comp.join(", "));

  const lang = [];
  if (val("pros_alt")) lang.push("prosodie altérée");
  if (val("int_hypo")) lang.push("intensité diminuée");
  if (val("int_hyper")) lang.push("intensité augmentée");
  if (val("ryth_dimin")) lang.push("rythme verbal diminué");
  if (val("ryth_augm")) lang.push("rythme verbal augmenté");
  if (val("ryth_alt")) lang.push("rythme verbal altéré (fading/barrages)");
  if (val("signif_alt")) lang.push("signification altérée (néologismes/paralogismes…)");
  if (lang.length) lines.push("- Langage : " + lang.join(", "));

  if (txtv("lang_rem")) lines.push("Remarques - Présentation/Langage : " + txtv("lang_rem"));
  return lines;
}

function buildB(){
  const lines = [], b = [];
  if (val("p_ryth_norm")) b.push("rythme de pensée normal");
  if (val("p_ryth_ral")) b.push("rythme de pensée ralenti (bradypsychie)");
  if (val("p_ryth_acc")) b.push("rythme de pensée accéléré (tachypsychie/fuite des idées)");
  if (val("p_cours_log")) b.push("cours de pensée logique/cohérent");
  if (val("p_cours_diff")) b.push("cours de pensée diffluent");
  if (val("p_cours_illog")) b.push("cours de pensée illogique");
  if (val("p_blocage")) b.push("blocage/barrages idéiques");
  if (b.length) lines.push("- Pensée (forme) : " + b.join(", "));
  if (txtv("p_forme_rem")) lines.push("Remarques - Pensée (forme) : " + txtv("p_forme_rem"));
  return lines;
}

function buildC(){
  const lines = [], cset = [];
  if (val("c_inquietudes")) cset.push("soucis et inquiétudes excessifs");
  if (val("c_obsessions")) cset.push("idées obsessionnelles");
  if (val("c_flashbacks")) cset.push("reviviscences/remémorations/flashbacks");
  if (val("c_phobies")) cset.push("idées phobiques");
  if (val("c_anticipation")) cset.push("idées liées à une anxiété anticipatoire");
  if (val("c_depressif")) cset.push("idées dépressives (négatives/dévalorisation/incurabilité)");
  if (val("c_exalte")) cset.push("idées liées à l’humeur exaltée (positives/grandeur/optimisme démesuré)");
  if (val("c_suicide")) {
    let s = "idées de mort/idées de suicide";
    const p = txtv("c_suicide_prec");
    if (p) s += " (" + p + ")";
    cset.push(s);
  }

if (val("c_delire")){
  const themes = [];
  if (val("d_pers")) themes.push("persécution");
  if (val("d_interp")) themes.push("interprétation");
  if (val("d_ref")) themes.push("référence");
  if (val("d_infl")) themes.push("influence");
  if (val("d_megalo")) themes.push("mégalomanie");
  if (val("d_hypo")) themes.push("hypochondrie/somatique");
  if (val("d_culp")) themes.push("culpabilité");
  if (val("d_jal")) themes.push("jalousie");
  if (val("d_ero")) themes.push("érotomanie");
  if (val("d_myst")) themes.push("mystique");
  if (val("d_ruine")) themes.push("ruine");
  if (val("d_fil")) themes.push("filiation");
  if (val("d_rev")) themes.push("revendication");
  if (val("d_neg")) themes.push("négation (Cotard)");
  if (val("d_trans")) themes.push("transformation corporelle");
  if (val("d_ident")) themes.push("identitaire");
  if (val("d_complot")) themes.push("complotiste");
  if (val("d_cosm")) themes.push("cosmique");
  if (val("d_meta")) themes.push("métaphysique");

  const meca = [];
  if (val("m_interp")) meca.push("interprétatif");
  if (val("m_hall")) meca.push("hallucinatoire");
  if (val("m_intuit")) meca.push("intuitif");
  if (val("m_pass")) meca.push("passionnel");
  if (val("m_imag")) meca.push("imaginatif");
  if (val("m_onir")) meca.push("onirique");
  if (val("m_mnem")) meca.push("mnémonique (fabulation)");
  if (val("m_sugg")) meca.push("suggéré/induit");

  let orga = "";
  if (val("d_sys")) orga = "systématisé";
  if (val("d_parano")) orga = "paranoïde";

  let temp = "";
  if (val("d_aigu")) temp = "aiguë (<1 mois)";
  if (val("d_chron")) temp = "chronique (>1 mois)";

  let bloc = "idées délirantes";
  if (themes.length) bloc += " à thème " + themes.join(", ");
  if (meca.length) bloc += ", mécanismes " + meca.join(", ");
  if (orga) bloc += ", organisation " + orga;
  if (temp) bloc += ", évolution " + temp;
  cset.push(bloc);
}
if (txtv("d_rem")) lines.push("Délire – retentissement/observations : " + txtv("d_rem"));

  if (cset.length) lines.push("- Pensée (contenu) : " + cset.join("; "));
  if (txtv("c_rem")) lines.push("Remarques - Pensée (contenu) : " + txtv("c_rem"));
  if (txtv("d_rem")) lines.push("Délire – précisions : " + txtv("d_rem"));
  return lines;
}

function buildD(){
  const lines = [], d = [];
  if (val("aff_emo_norm")) d.push("émotions dans les normes");
  if (val("aff_emo_dim")) d.push("émotions diminuées");
  if (val("aff_emo_aug")) d.push("émotions augmentées (hyperréactivité)");
  if (val("aff_emo_labile")) d.push("labilité émotionnelle");
  if (val("aff_emo_inadap")) d.push("émotions inadaptées");
  if (val("aff_euth")) d.push("humeur euthymique");
  if (val("aff_depr")) d.push("humeur dépressive");
  if (val("aff_exal")) d.push("humeur exaltée");
  if (val("aff_mixte")) d.push("humeur mixte");
  if (val("aff_anx")) d.push("anxiété marquée");
  if (val("aff_irrita")) d.push("irritabilité marquée");
  if (val("aff_anhed")) d.push("anhédonie");
  if (d.length) lines.push("- Affectivité : " + d.join(", "));
  if (txtv("aff_rem")) lines.push("Remarques - Affectivité : " + txtv("aff_rem"));
  return lines;
}

function buildE(){
  const lines = [], e = [];
  const hall = [];
  if (val("per_ha")) hall.push("auditives");
  if (val("per_hv")) hall.push("visuelles");
  if (val("per_hs")) hall.push("somesthésiques");
  if (val("per_holf")) hall.push("olfactives");
  if (val("per_hgust")) hall.push("gustatives");
  if (hall.length) e.push("hallucinations " + hall.join(", "));
  const autres = [];
  if (val("per_illu")) autres.push("illusions");
  if (val("per_intra")) autres.push("phénomènes intrapsychiques");
  if (autres.length) e.push(autres.join(", "));
  if (txtv("per_prec")) e.push("précisions : " + txtv("per_prec"));
  if (e.length) lines.push("- Perception : " + e.join("; "));
  if (txtv("per_rem")) lines.push("Remarques - Perception : " + txtv("per_rem"));
  return lines;
}

function buildF(){
  const lines = [], f = [];
  if (val("mot_norm")) f.push("motivation/initiative normale");
  if (val("mot_dim")) f.push("diminution de l’initiative (aboulie)");
  if (val("mot_aug")) f.push("initiative augmentée");
  if (f.length) lines.push("- Motivation : " + f.join(", "));
  if (txtv("mot_rem")) lines.push("Remarques - Motivation : " + txtv("mot_rem"));
  return lines;
}

function buildG(){
  const lines = [];


  // --- Orientation ---
  const orient = [];
  if (val("cog_orient_ok")) orient.push("orientation préservée");
  if (val("cog_orient_tps")) orient.push("désorientation temporelle");
  if (val("cog_orient_esp")) orient.push("désorientation spatiale");
  if (val("cog_orient_tmpesp")) orient.push("désorientation temporo-spatiale");
  if (orient.length) lines.push("- Orientation : " + orient.join(", "));

  // --- Attention ---
  const att = [];
  if (val("cog_att_ok")) att.push("attention préservée");
  if (val("cog_att_def")) att.push("hypoprosexie/distractibilité");
  if (att.length) lines.push("- Attention : " + att.join(", "));

  // --- Mémoire ---
  const mem = [];
  if (val("mem_ok")) mem.push("mémoire sans particularité");
  if (val("mem_trouble")) mem.push("troubles mnésiques");
  if (mem.length) lines.push("- Mémoire : " + mem.join(", "));

  // --- Fonctions instinctuelles ---
  const inst = [];
  if (val("sl_norm")) inst.push("sommeil normal");
  if (val("sl_insom")) inst.push("insomnie");
  if (val("sl_hypers")) inst.push("hypersomnie");
  if (val("app_norm")) inst.push("appétit normal");
  if (val("app_dim")) inst.push("appétit diminué");
  if (val("app_aug")) inst.push("appétit augmenté");
  if (val("sex_norm")) inst.push("sexualité sans particularité");
  if (val("sex_dim")) inst.push("sexualité diminuée");
  if (val("sex_aug")) inst.push("sexualité augmentée");
  if (inst.length) lines.push("- Fonctions instinctuelles : " + inst.join(", "));

  // --- Remarques libres ---
  if (txtv("cog_rem")) lines.push("Remarques – Cognition / fonctions instinctuelles : " + txtv("cog_rem"));

  return lines;
}

function buildH(){
  const lines = [], h = [];
  // Mimique
  if (val("mot_mim_norm")) h.push("mimique faciale normale");
  if (val("mot_mim_dim")) h.push("mimique faciale diminuée");
  if (val("mot_mim_aug")) h.push("mimique faciale augmentée");
  if (val("mot_mim_alt")) h.push("mimique faciale altérée qualitativement");

  // Activité psychomotrice
  if (val("mot_act_norm")) h.push("activité psychomotrice normale");
  if (val("mot_act_dim")) h.push("activité psychomotrice diminuée");
  if (val("mot_act_aug")) h.push("activité psychomotrice augmentée");
  if (val("mot_act_alt")) h.push("activité psychomotrice altérée qualitativement");

  if (h.length) lines.push("- Motricité : " + h.join(", "));
  if (txtv("motric_rem")) lines.push("Remarques - motricité : " + txtv("motric_rem"));
  return lines;
}

function buildI(){
  const lines = [], i = [];
  if (val("ins_abs")) i.push("insight absent");
  if (val("ins_part")) i.push("insight partiel");
  if (val("ins_comp")) i.push("insight complet");
  if (val("jug_ok")) i.push("jugement adapté");
  if (val("jug_alt")) i.push("jugement altéré");
  if (val("jug_imp")) i.push("impulsivité/prises de risques");
  if (i.length) lines.push("- Jugement/Insight : " + i.join(", "));
  if (txtv("ins_rem")) lines.push("Remarques - insight et jugement : " + txtv("ins_rem"));
  return lines;
}

function buildJ(){
  const lines = [];

  // --- Risque suicidaire ---
  const suic = [];
  if (val("r_s_none")) suic.push("absence d'idéation suicidaire"); 
  if (val("r_s_1")) suic.push("pensées de mort ou souhait d’être mort(e)");
  if (val("r_s_2")) suic.push("envie de se faire du mal");
  if (val("r_s_3")) suic.push("pensées suicidaires");
  if (val("r_s_4")) suic.push("planification du suicide");
  if (val("r_s_5")) suic.push("tentative de suicide au cours du dernier mois");
  if (val("r_s_6")) suic.push("antécédent de tentative de suicide au cours de la vie");
  if (suic.length){
    lines.push("- Risque suicidaire : " + suic.join(", "));
  }
  if (txtv("r_s_rem")) lines.push("Remarques – risque suicidaire : " + txtv("r_s_rem"));

  // --- Risque hétéro-agressif ---
  const hetero = [];
  if (val("r_h_none")) hetero.push("aucun risque identifié");
  if (val("r_h_1")) hetero.push("antécédents de passage à l’acte hétéro-agressif");
  if (val("r_h_2")) hetero.push("idées actuelles de passage à l’acte hétéro-agressif");
  if (val("r_h_3")) hetero.push("accessibilité des moyens pour un passage à l’acte déterminé");
  if (val("r_h_4")) hetero.push("possession ou intention d’acquérir une arme à feu");
  if (hetero.length){
    lines.push("- Risque hétéro-agressif : " + hetero.join(", "));
  }
  if (txtv("r_h_rem")) lines.push("Remarques – risque hétéro-agressif : " + txtv("r_h_rem"));

  return lines;
}

/* ----------- master prompt ----------- */
function buildReport(){
  const style = $("reportStyle").value; // narratif | detaille
  const gender = $("patientGender").value; //
  const patient = txtv("patientId");

  // Crée une instruction claire pour le LLM en fonction du genre
  let genderInstruction = "";
  switch (gender) {
    case "homme":
      genderInstruction = "Le patient est un homme. ";
      break;
    case "femme":
      genderInstruction = "La patiente est une femme. ";
      break;
    case "autre":
      genderInstruction = "Le genre de la personne est 'autre'. Utiliser un langage inclusif ou neutre. ";
      break;
  }
  const A = buildA(), B = buildB(), C = buildC(), D = buildD(), E = buildE(),
        F = buildF(), G = buildG(), H = buildH(), I = buildI(), J = buildJ();

  const has = (...arr) => arr.some(sec => sec.length > 0);
  if (!has(A,B,C,D,E,F,G,H,I,J)) return "";

  let patientInfo = patient ? ` pour le patient "${patient}"` : "";

  let header = (style === "detaille")
  ? `Rédige un status psychiatrique clinique en français${patientInfo}, structuré par rubriques. ${genderInstruction}Prends en compte les éléments suivants :`
  : `Rédige un status psychiatrique clinique${patientInfo}, en un seul bloc, sans décoration de texte, en français. ${genderInstruction}Prends en compte les éléments suivants :`;

  const out = [header];
  function pushBlock(label, lines){
    if (!lines.length) return;
    if (style === "detaille") out.push(`— ${label} :`);
    out.push(...lines);
  }
  pushBlock("Présentation / Langage", A);
  pushBlock("Pensée (forme)", B);
  pushBlock("Pensée (contenu)", C);
  pushBlock("Affectivité", D);
  pushBlock("Perception", E);
  pushBlock("Motivation", F);
  pushBlock("Attention / Mémoire / Instincts", G);
  pushBlock("Motricité", H);
  pushBlock("Jugement / Insight", I);
  pushBlock("Risques", J);

  return out.join("\n");
}

/* ----------- UI handlers ----------- */
$("generate").addEventListener("click", () => {
  $("output").textContent = buildReport();
});

$("copy").addEventListener("click", (e) => {
  const btn = e.target;
  const originalText = btn.textContent;
  const t = $("output").textContent.trim();

  // Si le bouton est déjà en cours d'animation ou si le champ est vide, ne rien faire
  if (btn.disabled || !t) return;

  // Désactive le bouton pour éviter les double-clics
  btn.disabled = true;

  navigator.clipboard.writeText(t).then(() => {
    btn.textContent = "Copié !";
    btn.style.opacity = 0.7;
    setTimeout(() => {
      btn.textContent = originalText;
      btn.style.opacity = 1;
      btn.disabled = false; // Réactive le bouton
    }, 1500);
  }).catch(err => {
    console.error('Erreur lors de la copie : ', err);
    btn.textContent = "Échec";
     setTimeout(() => {
      btn.textContent = originalText;
      btn.disabled = false; // Réactive aussi en cas d'échec
    }, 2000);
  });
});

$("reset").addEventListener("click", () => {
  document.querySelectorAll("input[type=checkbox]").forEach(el => el.checked = false);
  document.querySelectorAll("input[type=text], textarea").forEach(el => el.value = "");
  $("patientGender").value = "non-precise";
  $("output").textContent = "";
  updateSectionHighlights(); 
  updateCheckboxVisuals();
});

/* ----------- blocs repliables ----------- */
document.querySelectorAll('.collapsible').forEach(section => {
  section.addEventListener('click', () => {
    section.classList.toggle('collapsed');
    const content = section.nextElementSibling;
    if (section.classList.contains('collapsed')) {
      content.style.maxHeight = null;
    } else {
      content.style.maxHeight = content.scrollHeight + "px";
    }
  });
});

/* ----------- bouton tout replier / déplier ----------- */
const toggleAllBtn = document.getElementById('toggleAll');
let allCollapsed = false;

toggleAllBtn.addEventListener('click', () => {
  const sections = document.querySelectorAll('.collapsible');
  allCollapsed = !allCollapsed;
  sections.forEach(sec => {
    const content = sec.nextElementSibling;
    if (allCollapsed) {
      sec.classList.add('collapsed');
      content.style.maxHeight = null;
    } else {
      sec.classList.remove('collapsed');
      content.style.maxHeight = content.scrollHeight + "px";
    }
  });
  toggleAllBtn.textContent = allCollapsed ? "Tout déplier" : "Tout replier";
});

/* --- bouton "remonter en haut" --- */
const scrollBtn = document.createElement("button");
scrollBtn.id = "scrollTop";
scrollBtn.title = "Remonter en haut";
scrollBtn.textContent = "↑";
document.body.appendChild(scrollBtn);

window.addEventListener("scroll", () => {
  scrollBtn.style.display = window.scrollY > 200 ? "block" : "none";
});
scrollBtn.addEventListener("click", () => {
  window.scrollTo({ top: 0, behavior: "smooth" });
});

/* ----------- surbrillance des sections remplies ----------- */
function getVar(name, fallback){
  const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
  return v || fallback;
}

function updateSectionHighlights() {
  const active = getVar('--highlight-active', '#bfdbfe');
  const normal = getVar('--accent-light', '#e0f2fe');

  document.querySelectorAll('.collapsible').forEach(section => {
    const content = section.nextElementSibling;
    const hasChecked = content.querySelector('input[type=checkbox]:checked') !== null;
    const hasText = Array.from(content.querySelectorAll('textarea, input[type=text]'))
      .some(el => (el.value || "").trim() !== "");
    section.style.background = (hasChecked || hasText) ? active : normal;
  });
}

/* écouter texte ET checkboxes */
['input','change'].forEach(evt => {
  document.addEventListener(evt, updateSectionHighlights);
});

/* synchroniser au chargement */
window.addEventListener('DOMContentLoaded', updateSectionHighlights);


/* ----------- Initialisation des boutons de reset par section ----------- */
function initializeSectionResets() {
  document.querySelectorAll('.collapsible').forEach(section => {
    const resetButton = document.createElement('span');
    resetButton.className = 'reset-section';
    resetButton.textContent = '⟳'; // Icône de réinitialisation (Unicode)
    resetButton.title = 'Réinitialiser cette section';

    // Insère le bouton dans l'en-tête de la section
    section.appendChild(resetButton);

    resetButton.addEventListener('click', (event) => {
      // TRÈS IMPORTANT: empêche l'événement de se propager et de
      // déclencher le pliage/dépliage de la section.
      event.stopPropagation();

      const content = section.nextElementSibling;
      if (content) {
        // Décoche toutes les cases
        content.querySelectorAll('input[type=checkbox]').forEach(el => el.checked = false);
        // Vide tous les champs de texte et zones de texte
        content.querySelectorAll('input[type=text], textarea').forEach(el => el.value = "");
        
        // Met à jour immédiatement la couleur de l'en-tête
        updateSectionHighlights();
        // LIGNE À AJOUTER : Met à jour l'apparence des cases
        updateCheckboxVisuals(); 
      }     
    });
  });
}

// Appelle la fonction de création des boutons une fois la page chargée
window.addEventListener('DOMContentLoaded', initializeSectionResets);

// Sécurité avec de quitter la page
window.addEventListener('beforeunload', (event) => {
  // Vérifie si au moins une case est cochée ou un champ de texte est rempli.
  const hasInput = document.querySelector('input:checked, input[type=text][value]:not([value=""]), textarea:not(:empty)') !== null;
  
  if (hasInput) {
    // Annule l'événement pour déclencher l'avertissement du navigateur.
    event.preventDefault();
    // Requis par certains navigateurs plus anciens.
    event.returnValue = '';
  }
});

/* ---- GESTION VISUELLE DE TOUTES LES CASES À COCHER ---- */
function updateCheckboxVisuals() {
  // Cible TOUTES les cases à cocher de la page
  document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
    if (checkbox.parentElement.tagName === 'LABEL') {
      // Ajoute ou enlève la classe .is-checked sur le <label> parent
      checkbox.parentElement.classList.toggle('is-checked', checkbox.checked);
    }
  });
}

// Appelle la fonction au chargement de la page
window.addEventListener('DOMContentLoaded', updateCheckboxVisuals);

// Appelle la fonction à chaque changement (clic, reset, etc.)
document.addEventListener('change', updateCheckboxVisuals);

</script>

<button id="scrollTop" title="Remonter en haut">↑</button>

<footer>
  <p>
    Développé par <strong>Adrien Lorette</strong>.
  </p>
  <p class="license">
    Publié sous les termes de la <a href="https://opensource.org/licenses/MIT" target="_blank" rel="noopener noreferrer">Licence MIT</a>.
  </p>
</footer>

</body>
</html>
